<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, height=device-height, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>River Rapids: Bangladesh</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="game-container">
        <!-- Main Menu -->
        <div id="main-menu" class="game-screen active">
            <div class="logo">River Rapids: Bangladesh</div>
            <button id="play-game-btn" class="primary-btn">Play Game</button>
            <div class="connection-status-container">
                <span>Multiplayer: </span>
                <span id="connection-status" class="disconnected">Disconnected</span>
            </div>
            <div class="bottom-controls">
                <div class="music-toggle">
                    <label for="music-switch">Music</label>
                    <input type="checkbox" id="music-switch" checked>
                </div>
                <button id="exit-game-btn" class="secondary-btn">Exit Game</button>
            </div>
        </div>

        <!-- Kayak Selection Screen -->
        <div id="kayak-selection" class="game-screen">
            <h2>Select Your Kayak</h2>
            <div class="kayak-options">
                <div class="kayak-option" data-kayak="1">
                    <div class="kayak-image">Kayak 1</div>
                    <div class="kayak-stats">
                        <div class="stat-bar">
                            <span>Speed</span>
                            <div class="stat-fill" style="width: 90%"></div>
                        </div>
                        <div class="stat-bar">
                            <span>Maneuverability</span>
                            <div class="stat-fill" style="width: 50%"></div>
                        </div>
                        <div class="stat-bar">
                            <span>Durability</span>
                            <div class="stat-fill" style="width: 40%"></div>
                        </div>
                    </div>
                    <div class="kayak-description">Streamlined racing kayak (fastest, less maneuverability)</div>
                </div>
                <div class="kayak-option" data-kayak="2">
                    <div class="kayak-image">Kayak 2</div>
                    <div class="kayak-stats">
                        <div class="stat-bar">
                            <span>Speed</span>
                            <div class="stat-fill" style="width: 70%"></div>
                        </div>
                        <div class="stat-bar">
                            <span>Maneuverability</span>
                            <div class="stat-fill" style="width: 70%"></div>
                        </div>
                        <div class="stat-bar">
                            <span>Durability</span>
                            <div class="stat-fill" style="width: 60%"></div>
                        </div>
                    </div>
                    <div class="kayak-description">Balanced kayak (medium speed, medium maneuverability)</div>
                </div>
                <div class="kayak-option" data-kayak="3">
                    <div class="kayak-image">Kayak 3</div>
                    <div class="kayak-stats">
                        <div class="stat-bar">
                            <span>Speed</span>
                            <div class="stat-fill" style="width: 50%"></div>
                        </div>
                        <div class="stat-bar">
                            <span>Maneuverability</span>
                            <div class="stat-fill" style="width: 90%"></div>
                        </div>
                        <div class="stat-bar">
                            <span>Durability</span>
                            <div class="stat-fill" style="width: 80%"></div>
                        </div>
                    </div>
                    <div class="kayak-description">Sturdy traditional kayak (slower, highest maneuverability)</div>
                </div>
            </div>
            <div class="nav-buttons">
                <button id="back-from-kayak" class="secondary-btn">Back to Menu</button>
                <button id="confirm-kayak" class="primary-btn">Confirm Selection</button>
            </div>
        </div>

        <!-- River Selection Screen -->
        <div id="river-selection" class="game-screen">
            <h2>Select Your River</h2>
            <div class="river-options">
                <div class="river-option" data-river="padma">
                    <div class="river-image">Padma River</div>
                    <div class="river-info">
                        <div class="difficulty">
                            <span>Difficulty:</span>
                            <span class="stars">‚òÖ‚òÜ‚òÜ</span>
                        </div>
                        <div class="length">
                            <span>Length:</span>
                            <span>Medium</span>
                        </div>
                        <div class="features">
                            <span>Features:</span>
                            <span class="feature-icons">üåä üå≥</span>
                        </div>
                    </div>
                    <div class="river-description">Moderate difficulty, wide lanes</div>
                </div>
                <div class="river-option" data-river="jamuna">
                    <div class="river-image">Jamuna River</div>
                    <div class="river-info">
                        <div class="difficulty">
                            <span>Difficulty:</span>
                            <span class="stars">‚òÖ‚òÖ‚òÜ</span>
                        </div>
                        <div class="length">
                            <span>Length:</span>
                            <span>Short</span>
                        </div>
                        <div class="features">
                            <span>Features:</span>
                            <span class="feature-icons">üåä ü™® üå≥</span>
                        </div>
                    </div>
                    <div class="river-description">Higher difficulty, narrower lanes with more obstacles</div>
                </div>
                <div class="river-option" data-river="meghna">
                    <div class="river-image">Meghna River</div>
                    <div class="river-info">
                        <div class="difficulty">
                            <span>Difficulty:</span>
                            <span class="stars">‚òÖ‚òÖ‚òÖ</span>
                        </div>
                        <div class="length">
                            <span>Length:</span>
                            <span>Long</span>
                        </div>
                        <div class="features">
                            <span>Features:</span>
                            <span class="feature-icons">üåä üå™Ô∏è ü™® üå≥</span>
                        </div>
                    </div>
                    <div class="river-description">Advanced difficulty, variable width lanes with current variations</div>
                </div>
            </div>
            <div class="nav-buttons">
                <button id="back-from-river" class="secondary-btn">Back</button>
                <button id="confirm-river" class="primary-btn">Confirm Selection</button>
            </div>
        </div>

        <!-- Game Mode Selection -->
        <div id="mode-selection" class="game-screen">
            <h2>Select Game Mode</h2>
            <div class="mode-options">
                <button id="single-player-btn" class="mode-btn">Single Player</button>
                <button id="multiplayer-btn" class="mode-btn">Multiplayer</button>
            </div>
            <button id="back-from-mode" class="secondary-btn">Back</button>
        </div>

        <!-- Multiplayer Options -->
        <div id="multiplayer-options" class="game-screen">
            <h2>Multiplayer</h2>
            <div class="mp-options">
                <button id="create-room-btn" class="mode-btn">Create Room</button>
                <button id="join-room-btn" class="mode-btn">Join Room</button>
            </div>
            <button id="back-from-mp-options" class="secondary-btn">Back</button>
        </div>

        <!-- Create Room Screen -->
        <div id="create-room" class="game-screen">
            <h2>Room Created</h2>
            <div class="room-code-container">
                <h3>Room Code:</h3>
                <div id="room-code" class="room-code">XYZ123</div>
                <button id="share-code-btn" class="secondary-btn">Share Code</button>
            </div>
            <div class="player-slots">
                <div class="player-slot">
                    <div class="player-name">You (Host)</div>
                    <div class="player-kayak"></div>
                </div>
                <div class="player-slot waiting">
                    <div class="player-name">Waiting...</div>
                </div>
                <div class="player-slot waiting">
                    <div class="player-name">Waiting...</div>
                </div>
                <div class="player-slot waiting">
                    <div class="player-name">Waiting...</div>
                </div>
            </div>
            <div class="chat-container">
                <div class="chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Type a message...">
                    <button id="send-chat-btn">Send</button>
                </div>
            </div>
            <div class="nav-buttons">
                <button id="back-from-create-room" class="secondary-btn">Back</button>
                <button id="start-game-btn" class="primary-btn" disabled>Start Game</button>
            </div>
        </div>

        <!-- Join Room Screen -->
        <div id="join-room" class="game-screen">
            <h2>Join Room</h2>
            <div class="room-code-entry">
                <input type="text" id="room-code-input" placeholder="Enter room code">
                <button id="join-btn" class="primary-btn">Join</button>
            </div>
            
            <h3>Public Rooms</h3>
            <div class="public-rooms">
                <!-- Rooms will be populated dynamically -->
                <div class="no-rooms">Loading available rooms...</div>
            </div>
            
            <button id="refresh-rooms-btn" class="secondary-btn">Refresh Rooms</button>
            <button id="back-from-join-room" class="secondary-btn">Back</button>
        </div>

        <!-- Room Lobby -->
        <div id="room-lobby" class="game-screen">
            <h2>Room Lobby</h2>
            <div class="player-list">
                <!-- Players will be added dynamically -->
            </div>
            <div class="chat-container">
                <div class="chat-messages"></div>
                <div class="chat-input-container">
                    <input type="text" id="lobby-chat-input" placeholder="Type a message...">
                    <button id="send-lobby-chat-btn">Send</button>
                </div>
            </div>
            <div class="room-code-display">
                <span>Room Code: </span>
                <span id="lobby-room-code">XYZ123</span>
            </div>
            <div class="nav-buttons">
                <button id="leave-room-btn" class="secondary-btn">Leave Room</button>
                <button id="ready-btn" class="primary-btn">Ready</button>
                <button id="start-lobby-game-btn" class="primary-btn" disabled>Start Game</button>
            </div>
        </div>

        <!-- Gameplay Screen -->
        <div id="gameplay" class="game-screen">
            <div class="game-info">
                <div id="timer">00:00</div>
                <div id="position-indicator">Position: 1/4</div>
            </div>
            <div id="game-canvas-container">
                <canvas id="game-canvas"></canvas>
            </div>
            <div id="mobile-controls" class="mobile-only">
                <button id="left-paddle-btn" class="paddle-btn">Left</button>
                <button id="balance-btn" class="paddle-btn">Balance</button>
                <button id="right-paddle-btn" class="paddle-btn">Right</button>
                <button id="special-action-btn" class="paddle-btn">Special</button>
            </div>
            <div id="minimap-container">
                <canvas id="minimap"></canvas>
            </div>
        </div>

        <!-- End Game Screen -->
        <div id="end-game" class="game-screen">
            <h2>Race Results</h2>
            <div class="race-results">
                <!-- Results will be filled dynamically -->
                <div class="result-entry">
                    <div class="position">1st</div>
                    <div class="player-name">Player 1</div>
                    <div class="time">02:34.56</div>
                </div>
            </div>
            <div class="nav-buttons">
                <button id="play-again-btn" class="primary-btn">Play Again</button>
                <button id="return-to-lobby-btn" class="secondary-btn multiplayer-only">Return to Lobby</button>
                <button id="main-menu-btn" class="secondary-btn">Main Menu</button>
            </div>
        </div>
    </div>

    <!-- Load local Photon SDK implementation first -->
    <script src="js/photon-sdk.js"></script>
    
    <!-- Photon Scripts (CDN sources as backup) -->
    <script src="https://cdn.jsdelivr.net/npm/@exitgames/photon@4.1.2/lib/photon-browser.min.js"></script>
    
    <!-- Game Scripts -->
    <script src="js/photon.js"></script>
    <script src="js/photon-backup.js"></script>
    <script src="js/main.js"></script>
    
    <!-- Suppress "message port closed" errors -->
    <script>
        // Global error handler to suppress specific runtime errors
        window.addEventListener('error', function(event) {
            if (event && event.message && (
                event.message.includes('message port closed') || 
                event.message.includes('The message port closed') ||
                event.message.includes('Unchecked runtime.lastError')
            )) {
                console.log('Suppressing Chrome extension error:', event.message);
                event.stopPropagation();
                event.preventDefault();
                return true;
            }
        }, true);
    </script>
    
    <!-- Add Photon detection script -->
    <script>
        window.addEventListener('load', function() {
            // Ensure our local SDK is initialized, even if loading fails
            if (typeof Photon === 'undefined') {
                console.log('Creating local Photon SDK object');
                window.Photon = {
                    LoadBalancing: {
                        LoadBalancingClient: function() { 
                            this.connectToRegionMaster = function() { return true; };
                            this.setUserId = function() {};
                        },
                        State: {
                            ConnectedToMaster: 2,
                            JoinedLobby: 3,
                            JoinedRoom: 8,
                            Disconnected: 4
                        }
                    },
                    ConnectionProtocol: {
                        Wss: 1
                    }
                };
            }
            
            // Log success
            console.log('Photon SDK is available:', Photon);
            document.getElementById('connection-status').textContent = 'SDK Loaded';
            document.getElementById('connection-status').className = 'connected';
            
            // Add note about mock mode
            const connectionContainer = document.querySelector('.connection-status-container');
            if (connectionContainer) {
                // Remove any existing help text
                const existingHelp = connectionContainer.querySelector('div');
                if (existingHelp) {
                    existingHelp.remove();
                }
                
                // Add new help text
                const helpText = document.createElement('div');
                helpText.style.fontSize = '12px';
                helpText.style.marginTop = '5px';
                helpText.textContent = 'Using mock multiplayer mode';
                connectionContainer.appendChild(helpText);
            }
        });
    </script>
</body>
</html>